<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Kiraak Party - YouTube Sync</title>

<script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
<script src="https://www.youtube.com/iframe_api"></script>

<style>
body {
    margin:0;
    background:#0b0b0b;
    color:white;
    font-family:sans-serif;
    display:flex;
    flex-direction:column;
    height:100vh;
}

#player { flex:1; }

.controls {
    background:#1a1a1a;
    padding:20px;
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:15px;
}

input,button {
    padding:10px;
    border:none;
    border-radius:5px;
}

button {
    background:#e50914;
    color:white;
    cursor:pointer;
}

#status-dot {
    width:10px;
    height:10px;
    border-radius:50%;
    display:inline-block;
    background:red;
}
</style>
</head>
<body>

<div id="player"></div>

<div class="controls">

<div>
<div><span id="status-dot"></span> <b id="myid">Connecting...</b></div>
<input id="videoInput" placeholder="Paste Full YouTube Link">
<button onclick="loadVideo()">Load Video</button>
</div>

<div>
<input id="friendID" placeholder="Friend ID">
<button onclick="connectFriend()">Connect</button>
</div>

</div>

<script>
let player;
let peer = new Peer();
let connection;
let isRemote = false;

function onYouTubeIframeAPIReady() {
    player = new YT.Player('player', {
        height: '100%',
        width: '100%',
        videoId: '',
        events: {
            'onStateChange': onPlayerStateChange
        }
    });
}

peer.on('open', id => {
    document.getElementById('myid').innerText = "Your ID: " + id;
});

peer.on('connection', conn => {
    connection = conn;
    setupConn();
});

function connectFriend(){
    let id = document.getElementById("friendID").value;
    connection = peer.connect(id);
    setupConn();
}

function setupConn(){
    connection.on('open', ()=>{
        document.getElementById("status-dot").style.background="lime";
        alert("Connected ✅");
    });

    connection.on('data', data=>{
        if(data.type==="play"){
            isRemote=true;
            player.seekTo(data.time,true);
            player.playVideo();
        }
        else if(data.type==="pause"){
            isRemote=true;
            player.seekTo(data.time,true);
            player.pauseVideo();
        }
        else if(data.type==="load"){
            player.loadVideoById(data.id);
        }
    });
}

function extractVideoID(url){
    let regExp = /^.*(youtu.be\/|v\/|watch\?v=|&v=)([^#&?]*).*/;
    let match = url.match(regExp);
    return (match && match[2].length === 11) ? match[2] : null;
}

function loadVideo(){
    let input = document.getElementById("videoInput").value.trim();
    let vidID = extractVideoID(input);

    if(!vidID){
        alert("Invalid YouTube link ❌");
        return;
    }

    player.loadVideoById(vidID);

    if(connection && connection.open){
        connection.send({type:"load", id:vidID});
    }
}

function onPlayerStateChange(event){
    if(isRemote){ isRemote=false; return; }

    if(connection && connection.open){
        let time = player.getCurrentTime();

        if(event.data==YT.PlayerState.PLAYING){
            connection.send({type:"play", time:time});
        }
        else if(event.data==YT.PlayerState.PAUSED){
            connection.send({type:"pause", time:time});
        }
    }
}
</script>

</body>
</html>
